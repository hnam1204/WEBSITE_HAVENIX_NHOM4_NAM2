@model List<HV_NIX.Models.SessionCartItem>
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    var products = ViewBag.Products as Dictionary<int, HV_NIX.Models.Products>;
    decimal total = (decimal)ViewBag.TotalAmount;
}

<link rel="stylesheet" href="~/Content/cart.css" />

<main class="cart-container">
    <h1 class="cart-title">Giỏ Hàng Của Bạn</h1>

    @if (!Model.Any())
    {
        <div class="cart-empty">
            <h2>Giỏ hàng trống</h2>
            <p>Hãy thêm sản phẩm vào giỏ để mua sắm</p>
            <a href="/Product" class="btn-primary">Mua sắm ngay</a>
        </div>
        return;
    }

    <div class="cart-content">

        <!-- ========== DANH SÁCH SẢN PHẨM ========== -->
        <div class="cart-items">
            @foreach (var g in Model)
            {
                var p = products[g.ProductID];
                var img = Url.Content("~/Content/Images/" + p.Thumbnail);

                <div class="cart-item" data-id="@g.ProductID" data-size="@g.Size">
                    <img src="@img" alt="@p.ProductName" />

                    <div class="cart-info">
                        <h4>@p.ProductName</h4>
                        <p>Size: <b>@g.Size</b></p>
                        <p class="price">@g.Price.ToString("N0")₫</p>

                        <div class="quantity-control">
                            <button class="decrease">−</button>
                            <input type="text" class="quantity-input" value="@g.Quantity" readonly>
                            <button class="increase">+</button>
                        </div>
                    </div>

                    <button class="remove-btn removeSession">✖</button>
                </div>
            }
        </div>

        <!-- ========== TÓM TẮT ========== -->
        <div class="cart-summary">
            <h3>Tóm Tắt Đơn Hàng</h3>

            <div class="summary-row">
                <span>Tổng tiền:</span>
                <span id="totalAmount">@total.ToString("N0")₫</span>
            </div>

            <a href="/Account/Login" class="btn-checkout">Đăng nhập để thanh toán</a>
            <a href="/Product" class="continue-shopping">← Tiếp tục mua sắm</a>
        </div>

    </div>
</main>

@section Scripts {
    <script>
        function updateSession(pid, size, quantity) {
            fetch('/Cart/UpdateQuantitySession', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `productId=${pid}&size=${size}&quantity=${quantity}`
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById("totalAmount").textContent =
                            Number(data.totalAmount).toLocaleString("vi-VN") + "₫";
                    }
                });
        }

        document.querySelectorAll(".cart-item").forEach(item => {
            const id = item.dataset.id;
            const size = item.dataset.size;
            const input = item.querySelector(".quantity-input");

            item.querySelector(".decrease").onclick = () => {
                let q = parseInt(input.value);
                if (q > 1) { q--; input.value = q; updateSession(id, size, q); }
            };

            item.querySelector(".increase").onclick = () => {
                let q = parseInt(input.value);
                q++; input.value = q; updateSession(id, size, q);
            };

            item.querySelector(".removeSession").onclick = () => {
                fetch('/Cart/RemoveSession', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `productId=${id}&size=${size}`
                })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) location.reload();
                    });
            };
        });
    </script>
}


<style>
    /* ================== GIỎ HÀNG KHÁCH VÃNG LAI – CHUẨN 2025 ================== */

    :root {
        --bg: #E8F3FF;
        --card: #FFFFFF;
        --primary: #2BAA67;
        --red: #E53935;
        --text: #1A365D;
        --text2: #4A5568;
        --radius: 20px;
        --shadow: 0 12px 28px rgba(0,0,0,0.10);
        --input-bg: #F8FAFC;
    }

    /* ----- GLOBAL ----- */

    body {
        background: var(--bg);
        font-family: "Segoe UI", sans-serif;
    }

    .cart-container {
        max-width: 850px;
        margin: 0 auto;
        padding: 20px;
    }

    .cart-title {
        text-align: center;
        font-size: 32px;
        font-weight: 800;
        color: var(--text);
        margin-bottom: 15px;
    }

    /* ----- EMPTY CART ----- */

    .cart-empty {
        text-align: center;
        background: var(--card);
        padding: 45px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
    }

        .cart-empty svg {
            width: 80px;
            height: 80px;
            color: var(--text2);
            margin-bottom: 10px;
        }

        .cart-empty h2 {
            font-size: 24px;
            color: var(--text);
            font-weight: 700;
        }

        .cart-empty p {
            color: var(--text2);
            margin-bottom: 20px;
        }

    .btn-primary {
        background: var(--primary);
        padding: 14px 28px;
        border-radius: 12px;
        color: white;
        font-size: 18px;
        font-weight: 700;
        display: inline-block;
        text-decoration: none;
        transition: 0.25s;
    }

        .btn-primary:hover {
            background: #249658;
        }

    /* ----- CART LAYOUT ----- */

    .cart-content {
        display: grid;
        grid-template-columns: 1.25fr 0.75fr;
        gap: 25px;
    }

    @@media (max-width: 768px) {
        .cart-content {
            grid-template-columns: 1fr;
        }
    }

    /* ----- ITEM LIST ----- */

    .cart-items {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .cart-item {
        display: flex;
        background: var(--card);
        padding: 18px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        align-items: center;
        gap: 18px;
    }

        .cart-item img {
            width: 90px;
            height: 90px;
            border-radius: 14px;
            object-fit: cover;
            flex-shrink: 0;
        }

    .cart-info {
        flex: 1;
    }

        .cart-info h4 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 4px;
        }

        .cart-info p {
            margin: 2px 0;
            color: var(--text2);
        }

    .price {
        color: var(--red);
        font-weight: 700;
        font-size: 16px;
    }

    /* ----- QUANTITY CONTROL ----- */

    .quantity-control {
        margin-top: 6px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .quantity-control button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #E2F6EE;
            color: var(--primary);
            font-size: 18px;
            cursor: pointer;
            font-weight: 800;
            transition: 0.15s;
        }

            .quantity-control button:hover {
                background: #d4f3e7;
            }

    .quantity-input {
        width: 55px;
        height: 32px;
        text-align: center;
        border-radius: 10px;
        border: 2px solid #ddd;
        font-weight: 700;
        background: #fff;
    }

    /* ----- REMOVE BUTTON ----- */

    .remove-btn {
        background: none;
        border: none;
        font-size: 20px;
        cursor: pointer;
        color: #888;
        transition: 0.2s;
    }

        .remove-btn:hover {
            color: var(--red);
        }

    /* ----- SUMMARY BOX ----- */

    .cart-summary {
        background: var(--card);
        padding: 25px;
        border-radius: 18px;
        box-shadow: var(--shadow);
        height: fit-content;
    }

        .cart-summary h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 20px;
            text-align: center;
        }

    .summary-row {
        display: flex;
        justify-content: space-between;
        font-size: 18px;
        margin-bottom: 20px;
    }

    #totalAmount {
        font-weight: 800;
        color: var(--red);
    }

    .btn-checkout {
        display: block;
        width: 100%;
        text-align: center;
        background: var(--primary);
        padding: 16px;
        color: white;
        border-radius: 14px;
        font-size: 18px;
        font-weight: 700;
        margin-bottom: 15px;
        transition: 0.25s;
    }

        .btn-checkout:hover {
            background: #249658;
        }

    .continue-shopping {
        display: block;
        text-align: center;
        font-size: 16px;
        color: var(--text2);
        text-decoration: none;
    }

        .continue-shopping:hover {
            text-decoration: underline;
        }
</style>